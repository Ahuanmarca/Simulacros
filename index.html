<!DOCTYPE html>
<html lang="es">
  <head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <link rel="apple-touch-icon" href="/icon.png" />
    <meta charset="UTF-8" />
    <title>Quiz RENFE</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #fefefe;
        color: #333;
        padding: 2em;
      }
      .menu {
        max-width: 600px;
        margin: auto;
        text-align: center;
      }
      .menu button {
        display: block;
        margin: 1em auto;
        padding: 1em;
        width: 100%;
        max-width: 300px;
        font-size: 1.2em;
        cursor: pointer;
      }
      .quiz-box,
      .summary {
        max-width: 800px;
        margin: auto;
        border: 1px solid #ccc;
        padding: 2em;
        border-radius: 8px;
        background: #fff;
      }
      .question {
        font-size: 1.1em;
        margin-bottom: 1em;
        white-space: pre-wrap;
      }
      .options {
        margin-bottom: 1em;
      }
      .options button {
        display: block;
        width: 100%;
        padding: 0.5em;
        margin: 0.3em 0;
        font-size: 1em;
        cursor: pointer;
        text-align: left;
      }
      .options button.selected {
        background-color: #e0f7fa;
        border: 2px solid #00796b;
      }
      .options button.correct-answer {
        background-color: #d4edda;
        border: 2px solid green;
      }
      .options button.incorrect-answer {
        background-color: #f8d7da;
        border: 2px solid red;
      }
      .options button.highlighted {
        outline: 2px solid #00796b;
        background-color: #e0f7fa;
      }
      .feedback {
        margin-top: 1em;
        font-style: italic;
        white-space: pre-wrap;
      }
      .feedback.correct {
        color: green;
      }
      .feedback.incorrect {
        color: red;
        font-style: normal;
      }
      #nextBtn {
        margin-top: 1em;
        padding: 0.5em 1em;
        font-size: 1em;
      }
      .resumen-pregunta {
        margin-bottom: 2em;
        padding: 1em;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #fafafa;
      }
      .resumen-pregunta.incorrecta {
        border-left: 5px solid red;
      }
      .resumen-pregunta.pasada {
        border-left: 5px solid gray;
      }
      hr {
        margin-top: 1.5em;
        border: none;
        border-top: 1px solid #ccc;
      }
    </style>
    <!-- AQUI -->
    <script src="cuestionarios/2025-01.js"></script>
    <script src="cuestionarios/2025-02.js"></script>
    <script src="cuestionarios/2025-03.js"></script>
    <script src="cuestionarios/2025-04.js"></script>
    <script src="cuestionarios/2025-05.js"></script>
    <script src="cuestionarios/test.js"></script>
  </head>
  <body>
    <div class="menu" id="menu">
      <h1>Elige un cuestionario</h1>
      <!-- AQUI -->
      <button onclick="iniciarQuiz('2025-01')">2025-01</button>
      <button onclick="iniciarQuiz('2025-02')">2025-02</button>
      <button onclick="iniciarQuiz('2025-03')">2025-03</button>
      <button onclick="iniciarQuiz('2025-04')">2025-04</button>
      <button onclick="iniciarQuiz('2025-05')">2025-05</button>
      <button onclick="iniciarQuiz('test')">test</button>
    </div>
    <div class="quiz-box" id="quizBox" style="display: none"></div>
    <div class="summary" id="summary" style="display: none"></div>

    <script>
      // AQUI
      const datasets = {
        "2025-01": preguntas_2025_01,
        "2025-02": preguntas_2025_02,
        "2025-03": preguntas_2025_03,
        "2025-04": preguntas_2025_04,
        "2025-05": preguntas_2025_05,
        "test": test,
      };

      let current = 0;
      let preguntas = [];
      let answers = [];
      let awaitingNext = false;
      let arrowSelected = null;
      let hasMovedWithArrow = false;

      function iniciarQuiz(id) {
        preguntas = datasets[id];
        current = 0;
        answers = [];
        document.getElementById("menu").style.display = "none";
        document.getElementById("quizBox").style.display = "block";
        document.getElementById("summary").style.display = "none";
        showQuestion(current);
      }

      function showMenu() {
        document.getElementById("menu").style.display = "block";
        document.getElementById("quizBox").style.display = "none";
        document.getElementById("summary").style.display = "none";
      }

      function showQuestion(index) {
        const q = preguntas[index];
        arrowSelected = null;
        hasMovedWithArrow = false;
        const box = document.getElementById("quizBox");
        box.innerHTML = `
          <div class="question">${q.pregunta}</div>
          <div class="options">
            ${q.opciones
              .map(
                (opt, i) =>
                  `<button onclick="submitAnswer(${i})" id="btn${i}">${opt}</button>`
              )
              .join("")}
            <button onclick="submitAnswer(null)" id="btnPass">Pasar</button>
          </div>
          <div id="feedback"></div>
          <button id="nextBtn" style="display:none" onclick="nextQuestion()">Siguiente</button>
        `;
        awaitingNext = false;
      }

      function submitAnswer(selected) {
        if (awaitingNext) return;
        awaitingNext = true;
        const q = preguntas[current];
        const correctaLetra = q.correcta.trim().charAt(0).toLowerCase();
        const correctaIdx = q.opciones.findIndex(
          (opt) => opt.trim().charAt(0).toLowerCase() === correctaLetra
        );

        const isCorrect = selected === correctaIdx;
        const feedbackBox = document.getElementById("feedback");
        const nextBtn = document.getElementById("nextBtn");

        document.querySelectorAll(".options button").forEach((btn, i) => {
          btn.disabled = true;
          btn.classList.remove(
            "selected",
            "correct-answer",
            "incorrect-answer",
            "highlighted"
          );
          if (i === correctaIdx) btn.classList.add("correct-answer");
        });

        if (selected !== null) {
          const selectedBtn = document.getElementById(`btn${selected}`);
          if (isCorrect) selectedBtn.classList.add("selected");
          else selectedBtn.classList.add("incorrect-answer");
        } else {
          document.getElementById("btnPass").classList.add("selected");
        }

        const formattedComment = q.comentario.replace(/\n/g, "<br>");

        if (selected === null) {
          feedbackBox.innerHTML = `<div class="feedback">Pasada. ${formattedComment}</div>`;
          answers.push({ selected: null, correct: false });
        } else if (isCorrect) {
          feedbackBox.innerHTML = `<div class="feedback correct">¡Correcta!</div>`;
          answers.push({ selected, correct: true });
        } else {
          feedbackBox.innerHTML = `<div class="feedback"><span class="incorrect">Incorrecta.</span> ${formattedComment}</div>`;
          answers.push({ selected, correct: false });
        }

        nextBtn.style.display = "inline-block";
      }

      function nextQuestion() {
        current++;
        if (current < preguntas.length) showQuestion(current);
        else showSummary();
      }

      function showSummary() {
        document.getElementById("quizBox").style.display = "none";
        const summary = document.getElementById("summary");
        summary.style.display = "block";

        const total = preguntas.length;
        const correct = answers.filter((a) => a.correct).length;
        const passed = answers.filter((a) => a.selected === null).length;
        const incorrect = total - correct - passed;

        summary.innerHTML = `
    <h2>Resumen del cuestionario</h2>
    <p>Correctas: <strong>${correct}</strong></p>
    <p>Incorrectas: <strong>${incorrect}</strong></p>
    <p>Pasadas: <strong>${passed}</strong></p>
    <h3>Revisar preguntas con error o pasadas</h3>
    ${preguntas
      .map((q, i) => {
        const user = answers[i];
        if (user.correct) return "";
        const selectedText =
          user.selected === null ? "—" : q.opciones[user.selected];
        const correctText = q.correcta;
        const statusClass = user.selected === null ? "pasada" : "incorrecta";
        const statusLabel = user.selected === null ? "Pasada" : "Incorrecta";
        const comentario = q.comentario?.replace(/\n/g, "<br>") || "";
        return `
          <div class="resumen-pregunta ${statusClass}">
            <p><strong>Pregunta ${i + 1}:</strong> ${q.pregunta}</p>
            <p><strong>Tu respuesta:</strong> ${selectedText}</p>
            <p><strong>Respuesta correcta:</strong> ${correctText}</p>
            <p><strong>Estado:</strong> <span class="${statusClass}">${statusLabel}</span></p>
            <div class="comentario"><em>${comentario}</em></div>
            <hr>
          </div>
        `;
      })
      .join("")}
  `;
      }

      document.addEventListener("keydown", (e) => {
        const key = e.key.toLowerCase();

        if (awaitingNext) {
          if (key === " " || key === "spacebar" || key === "enter") {
            nextQuestion();
          } else if (key === "escape") {
            showMenu();
          }
          return;
        }

        const keyMap = {
          1: 0,
          2: 1,
          3: 2,
          4: 3,
          5: null,
          a: 0,
          b: 1,
          c: 2,
          d: 3,
          p: null,
        };
        if (key in keyMap) {
          submitAnswer(keyMap[key]);
          return;
        }

        if (key === "arrowdown" || key === "arrowup") {
          const optionButtons = Array.from(
            document.querySelectorAll(".options button")
          );
          if (!hasMovedWithArrow) {
            arrowSelected = 0;
            hasMovedWithArrow = true;
          } else {
            arrowSelected += key === "arrowdown" ? 1 : -1;
            if (arrowSelected < 0) arrowSelected = optionButtons.length - 1;
            if (arrowSelected >= optionButtons.length) arrowSelected = 0;
          }
          optionButtons.forEach((btn, i) => {
            btn.classList.toggle("highlighted", i === arrowSelected);
          });
        }

        if (key === "enter" && hasMovedWithArrow) {
          submitAnswer(arrowSelected);
        }
      });
    </script>
  </body>
</html>
